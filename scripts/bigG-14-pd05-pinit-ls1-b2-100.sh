#!/bin/bash
#SBATCH --partition=g80n140
#SBATCH --job-name=sopenclip
#SBATCH --nodes 100
#SBATCH --ntasks-per-node=8
#SBATCH --cpus-per-task=12
#SBATCH --output=%x_%j.out
#SBATCH --comment=laion
#SBATCH --open-mode=append
#SBATCH --exclusive
#SBATCH --exclude=ip-26-0-160-13
# #SBATCH --exclude ip-26-0-162-199,ip-26-0-162-203,ip-26-0-162-199,ip-26-0-162-203,ip-26-0-162-199,ip-26-0-162-203,ip-26-0-162-199,ip-26-0-162-203,ip-26-0-162-199,ip-26-0-162-203,ip-26-0-162-199,ip-26-0-162-203,ip-26-0-162-199,ip-26-0-162-203,ip-26-0-162-199,ip-26-0-162-203,ip-26-0-170-154,ip-26-0-171-106,ip-26-0-170-154,ip-26-0-171-106,ip-26-0-170-154,ip-26-0-171-106,ip-26-0-170-154,ip-26-0-171-106,ip-26-0-170-154,ip-26-0-171-106,ip-26-0-170-154,ip-26-0-171-106,ip-26-0-170-154,ip-26-0-171-106,ip-26-0-170-154,ip-26-0-171-106,ip-26-0-170-18,ip-26-0-170-55,ip-26-0-170-18,ip-26-0-170-55,ip-26-0-170-18,ip-26-0-170-55,ip-26-0-170-18,ip-26-0-170-55,ip-26-0-170-18,ip-26-0-170-55,ip-26-0-170-18,ip-26-0-170-55,ip-26-0-170-18,ip-26-0-170-55,ip-26-0-170-18,ip-26-0-170-55,ip-26-0-166-55,ip-26-0-166-61,ip-26-0-166-55,ip-26-0-166-61,ip-26-0-166-55,ip-26-0-166-61,ip-26-0-166-55,ip-26-0-166-61,ip-26-0-166-55,ip-26-0-166-61,ip-26-0-166-55,ip-26-0-166-61,ip-26-0-166-55,ip-26-0-166-61,ip-26-0-166-55,ip-26-0-166-61,ip-26-0-173-96,ip-26-0-173-98,ip-26-0-173-96,ip-26-0-173-98,ip-26-0-173-96,ip-26-0-173-98,ip-26-0-173-96,ip-26-0-173-98,ip-26-0-173-96,ip-26-0-173-98,ip-26-0-173-96,ip-26-0-173-98,ip-26-0-173-96,ip-26-0-173-98,ip-26-0-173-96,ip-26-0-173-98,ip-26-0-170-194,ip-26-0-170-200,ip-26-0-170-194,ip-26-0-170-200,ip-26-0-170-194,ip-26-0-170-200,ip-26-0-170-194,ip-26-0-170-200,ip-26-0-170-194,ip-26-0-170-200,ip-26-0-170-194,ip-26-0-170-200,ip-26-0-170-194,ip-26-0-170-200,ip-26-0-170-194,ip-26-0-170-200,ip-26-0-168-100,ip-26-0-168-100,ip-26-0-168-100,ip-26-0-168-100,ip-26-0-168-100,ip-26-0-168-100,ip-26-0-168-100,ip-26-0-168-100,ip-26-0-175-80,ip-26-0-175-90,ip-26-0-175-80,ip-26-0-175-90,ip-26-0-175-80,ip-26-0-175-90,ip-26-0-175-80,ip-26-0-175-90,ip-26-0-175-80,ip-26-0-175-90,ip-26-0-175-80,ip-26-0-175-90,ip-26-0-175-80,ip-26-0-175-90,ip-26-0-175-80,ip-26-0-175-90,ip-26-0-174-226,ip-26-0-175-68,ip-26-0-174-226,ip-26-0-175-68,ip-26-0-174-226,ip-26-0-175-68,ip-26-0-174-226,ip-26-0-175-68,ip-26-0-174-226,ip-26-0-175-68,ip-26-0-174-226,ip-26-0-175-68,ip-26-0-174-226,ip-26-0-175-68,ip-26-0-174-226,ip-26-0-175-68,ip-26-0-162-126,ip-26-0-162-181,ip-26-0-162-126,ip-26-0-162-181,ip-26-0-162-126,ip-26-0-162-181,ip-26-0-162-126,ip-26-0-162-181,ip-26-0-162-126,ip-26-0-162-181,ip-26-0-162-126,ip-26-0-162-181,ip-26-0-162-126,ip-26-0-162-181,ip-26-0-162-126,ip-26-0-162-181,ip-26-0-163-220,ip-26-0-164-80,ip-26-0-163-220,ip-26-0-164-80,ip-26-0-163-220,ip-26-0-164-80,ip-26-0-163-220,ip-26-0-164-80,ip-26-0-163-220,ip-26-0-164-80,ip-26-0-163-220,ip-26-0-164-80,ip-26-0-163-220,ip-26-0-164-80,ip-26-0-163-220,ip-26-0-164-80,ip-26-0-161-75,ip-26-0-161-115,ip-26-0-161-75,ip-26-0-161-115,ip-26-0-161-75,ip-26-0-161-115,ip-26-0-161-75,ip-26-0-161-115,ip-26-0-161-75,ip-26-0-161-115,ip-26-0-161-75,ip-26-0-161-115,ip-26-0-161-75,ip-26-0-161-115,ip-26-0-161-75,ip-26-0-161-115,ip-26-0-174-26,ip-26-0-174-44,ip-26-0-174-26,ip-26-0-174-44,ip-26-0-174-26,ip-26-0-174-44,ip-26-0-174-26,ip-26-0-174-44,ip-26-0-174-26,ip-26-0-174-44,ip-26-0-174-26,ip-26-0-174-44,ip-26-0-174-26,ip-26-0-174-44,ip-26-0-174-26,ip-26-0-174-44,ip-26-0-162-186,ip-26-0-163-77,ip-26-0-162-186,ip-26-0-163-77,ip-26-0-162-186,ip-26-0-163-77,ip-26-0-162-186,ip-26-0-163-77,ip-26-0-162-186,ip-26-0-163-77,ip-26-0-162-186,ip-26-0-163-77,ip-26-0-162-186,ip-26-0-163-77,ip-26-0-162-186,ip-26-0-163-77,ip-26-0-169-64,ip-26-0-169-95,ip-26-0-169-64,ip-26-0-169-95,ip-26-0-169-64,ip-26-0-169-95,ip-26-0-169-64,ip-26-0-169-95,ip-26-0-169-64,ip-26-0-169-95,ip-26-0-169-64,ip-26-0-169-95,ip-26-0-169-64,ip-26-0-169-95,ip-26-0-169-64,ip-26-0-169-95,ip-26-0-164-121,ip-26-0-165-144,ip-26-0-164-121,ip-26-0-165-144,ip-26-0-164-121,ip-26-0-165-144,ip-26-0-164-121,ip-26-0-165-144,ip-26-0-164-121,ip-26-0-165-144,ip-26-0-164-121,ip-26-0-165-144,ip-26-0-164-121,ip-26-0-165-144,ip-26-0-164-121,ip-26-0-165-144,ip-26-0-166-3,ip-26-0-166-68,ip-26-0-166-3,ip-26-0-166-68,ip-26-0-166-3,ip-26-0-166-68,ip-26-0-166-3,ip-26-0-166-68,ip-26-0-166-3,ip-26-0-166-68,ip-26-0-166-3,ip-26-0-166-68,ip-26-0-166-3,ip-26-0-166-68,ip-26-0-166-3,ip-26-0-166-68,ip-26-0-174-191,ip-26-0-175-145,ip-26-0-174-191,ip-26-0-175-145,ip-26-0-174-191,ip-26-0-175-145,ip-26-0-174-191,ip-26-0-175-145,ip-26-0-174-191,ip-26-0-175-145,ip-26-0-174-191,ip-26-0-175-145,ip-26-0-174-191,ip-26-0-175-145,ip-26-0-174-191,ip-26-0-175-145,ip-26-0-173-61,ip-26-0-173-114,ip-26-0-173-61,ip-26-0-173-114,ip-26-0-173-61,ip-26-0-173-114,ip-26-0-173-61,ip-26-0-173-114,ip-26-0-173-61,ip-26-0-173-114,ip-26-0-173-61,ip-26-0-173-114,ip-26-0-173-61,ip-26-0-173-114,ip-26-0-173-61,ip-26-0-173-114,ip-26-0-172-149,ip-26-0-172-184,ip-26-0-172-149,ip-26-0-172-184,ip-26-0-172-149,ip-26-0-172-184,ip-26-0-172-149,ip-26-0-172-184,ip-26-0-172-149,ip-26-0-172-184,ip-26-0-172-149,ip-26-0-172-184,ip-26-0-172-149,ip-26-0-172-184,ip-26-0-172-149,ip-26-0-172-184,ip-26-0-171-247,ip-26-0-171-247,ip-26-0-171-247,ip-26-0-171-247,ip-26-0-171-247,ip-26-0-171-247,ip-26-0-171-247,ip-26-0-171-247,ip-26-0-173-255,ip-26-0-174-154,ip-26-0-173-255,ip-26-0-174-154,ip-26-0-173-255,ip-26-0-174-154,ip-26-0-173-255,ip-26-0-174-154,ip-26-0-173-255,ip-26-0-174-154,ip-26-0-173-255,ip-26-0-174-154,ip-26-0-173-255,ip-26-0-174-154,ip-26-0-173-255,ip-26-0-174-154,ip-26-0-164-29,ip-26-0-165-179,ip-26-0-164-29,ip-26-0-165-179,ip-26-0-164-29,ip-26-0-165-179,ip-26-0-164-29,ip-26-0-165-179,ip-26-0-164-29,ip-26-0-165-179,ip-26-0-164-29,ip-26-0-165-179,ip-26-0-164-29,ip-26-0-165-179,ip-26-0-164-29,ip-26-0-165-179,ip-26-0-169-118,ip-26-0-169-172,ip-26-0-169-118,ip-26-0-169-172,ip-26-0-169-118,ip-26-0-169-172,ip-26-0-169-118,ip-26-0-169-172,ip-26-0-169-118,ip-26-0-169-172,ip-26-0-169-118,ip-26-0-169-172,ip-26-0-169-118,ip-26-0-169-172,ip-26-0-169-118,ip-26-0-169-172,ip-26-0-170-129,ip-26-0-170-129,ip-26-0-170-129,ip-26-0-170-129,ip-26-0-170-129,ip-26-0-170-129,ip-26-0-170-129,ip-26-0-170-129,ip-26-0-167-219,ip-26-0-168-172,ip-26-0-167-219,ip-26-0-168-172,ip-26-0-167-219,ip-26-0-168-172,ip-26-0-167-219,ip-26-0-168-172,ip-26-0-167-219,ip-26-0-168-172,ip-26-0-167-219,ip-26-0-168-172,ip-26-0-167-219,ip-26-0-168-172,ip-26-0-167-219,ip-26-0-168-172,ip-26-0-175-194,ip-26-0-175-225,ip-26-0-175-194,ip-26-0-175-225,ip-26-0-175-194,ip-26-0-175-225,ip-26-0-175-194,ip-26-0-175-225,ip-26-0-175-194,ip-26-0-175-225,ip-26-0-175-194,ip-26-0-175-225,ip-26-0-175-194,ip-26-0-175-225,ip-26-0-175-194,ip-26-0-175-225,ip-26-0-162-33,ip-26-0-162-75,ip-26-0-162-33,ip-26-0-162-75,ip-26-0-162-33,ip-26-0-162-75,ip-26-0-162-33,ip-26-0-162-75,ip-26-0-162-33,ip-26-0-162-75,ip-26-0-162-33,ip-26-0-162-75,ip-26-0-162-33,ip-26-0-162-75,ip-26-0-162-33,ip-26-0-162-75

module load openmpi
# source /opt/intel/mpi/latest/env/vars.sh

export PYTHONFAULTHANDLER=1
export CUDA_LAUNCH_BLOCKING=0
# sent to sub script
export HOSTNAMES=`scontrol show hostnames "$SLURM_JOB_NODELIST"`
export MASTER_ADDR=$(scontrol show hostnames "$SLURM_JOB_NODELIST" | head -n 1)
export MASTER_PORT=12802
export COUNT_NODE=`scontrol show hostnames "$SLURM_JOB_NODELIST" | wc -l`

echo go $COUNT_NODE
echo $HOSTNAMES

cd /fsx/home-mitchellw/forks/open_clip_fork/src
export PYTHONPATH="$PYTHONPATH:/fsx/home-mitchellw/forks/open_clip_fork/src"

EXP_NAME="clip-bigG14-pd05-ls1-pinit-160k-2e-3-0.95-amp_bfloat16-v1"

srun --comment laion --cpu_bind=v --accel-bind=gn python -m training.main \
    --save-frequency 1 \
    --train-data="pipe:aws s3 cp s3://s-datasets/laion5b/laion2B-data/{000000..231349}.tar -" \
    --train-num-samples 135646078 \
    --dataset-type webdataset \
    --dataset-resampled \
    --warmup 13000 \
    --batch-size=200 \
    --epochs=256 \
    --lr 2e-3 \
    --beta2 0.95 \
    --workers=4 \
    --report-to wandb \
    --name ${EXP_NAME} \
    --logs /fsx/home-mitchellw/experimetns/open_clip/ \
    --model ViT-bigG-14-pd05-ls1 \
    --seed 0 \
    --ddp-static-graph \
    --local-loss \
    --gather-with-grad \
    --grad-checkpointing \
    --precision amp_bfloat16 \
    --save-most-recent \
    --advanced-logging \
    --wandb-project-name open_clip6 \
    --pinit
