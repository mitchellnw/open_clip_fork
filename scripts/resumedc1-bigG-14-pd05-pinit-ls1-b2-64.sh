#!/bin/bash
#SBATCH --partition=g80n140
#SBATCH --job-name=sopenclip
#SBATCH --nodes 64
#SBATCH --ntasks-per-node=8
#SBATCH --cpus-per-task=12
#SBATCH --output=%x_%j.out
#SBATCH --comment=openclip
#SBATCH --open-mode=append
#SBATCH --exclusive
#SBATCH --exclude ip-26-0-166-164,ip-26-0-162-75,ip-26-0-166-61,ip-26-0-162-33
# #SBATCH -w ip-26-0-160-5,ip-26-0-162-181,ip-26-0-162-210,ip-26-0-162-226,ip-26-0-162-238,ip-26-0-163-9,ip-26-0-163-129,ip-26-0-163-220,ip-26-0-163-225,ip-26-0-163-226,ip-26-0-163-245,ip-26-0-163-251,ip-26-0-164-29,ip-26-0-164-80,ip-26-0-164-121,ip-26-0-165-144,ip-26-0-165-179,ip-26-0-166-3,ip-26-0-166-55,ip-26-0-166-107,ip-26-0-166-108,ip-26-0-166-121,ip-26-0-166-143,ip-26-0-166-169,ip-26-0-166-252,ip-26-0-167-61,ip-26-0-167-83,ip-26-0-167-150,ip-26-0-167-178,ip-26-0-168-172,ip-26-0-169-64,ip-26-0-169-95,ip-26-0-169-118,ip-26-0-169-140,ip-26-0-169-143,ip-26-0-169-172,ip-26-0-171-4,ip-26-0-171-5,ip-26-0-171-8,ip-26-0-171-43,ip-26-0-171-57,ip-26-0-171-135,ip-26-0-171-150,ip-26-0-171-191,ip-26-0-171-195,ip-26-0-171-247,ip-26-0-172-226,ip-26-0-173-9,ip-26-0-173-35,ip-26-0-173-49,ip-26-0-173-59,ip-26-0-173-61,ip-26-0-173-76,ip-26-0-173-96,ip-26-0-173-98,ip-26-0-173-114,ip-26-0-175-68,ip-26-0-175-80,ip-26-0-175-90,ip-26-0-175-107,ip-26-0-175-113,ip-26-0-175-145,ip-26-0-175-194,ip-26-0-175-210

module load openmpi
# source /opt/intel/mpi/latest/env/vars.sh

export PYTHONFAULTHANDLER=1
export CUDA_LAUNCH_BLOCKING=0
# sent to sub script
export HOSTNAMES=`scontrol show hostnames "$SLURM_JOB_NODELIST"`
export MASTER_ADDR=$(scontrol show hostnames "$SLURM_JOB_NODELIST" | head -n 1)
export MASTER_PORT=12802
export COUNT_NODE=`scontrol show hostnames "$SLURM_JOB_NODELIST" | wc -l`

echo go $COUNT_NODE
echo $HOSTNAMES

cd /fsx/home-mitchellw/forks/open_clip_fork/src
export PYTHONPATH="$PYTHONPATH:/fsx/home-mitchellw/forks/open_clip_fork/src"

EXP_NAME="bigG14-unmasked-tuning-dc1"

#/opt/slurm/sbin/srun --comment openclip --cpu_bind=v --accel-bind=gn python -m training.main \
#torchrun --nproc_per_node 8 -m training.main \
srun --comment openclip --cpu_bind=v --accel-bind=gn python -m training.main \
    --save-frequency 1 \
    --train-data="s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/4/{00000000..00004456}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/5/{00000000..00004462}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/6/{00000000..00004482}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/7/{00000000..00004662}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/8/{00000000..00004615}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/9/{00000000..00004611}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/10/{00000000..00004574}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/11/{00000000..00004702}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/12/{00000000..00004695}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/13/{00000000..00004666}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/17/{00000000..00003582}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/18/{00000000..00003474}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/19/{00000000..00003443}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/20/{00000000..00003053}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/21/{00000000..00002843}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/22/{00000000..00002628}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/23/{00000000..00002608}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/24/{00000000..00002771}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/25/{00000000..00002943}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/26/{00000000..00003095}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/27/{00000000..00003143}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/28/{00000000..00003133}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/29/{00000000..00003829}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/30/{00000000..00003793}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/31/{00000000..00003507}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/32/{00000000..00003456}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/33/{00000000..00003310}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/34/{00000000..00002962}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/35/{00000000..00003010}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/36/{00000000..00002878}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/37/{00000000..00002719}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/61/{00000000..00003512}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/62/{00000000..00003455}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/65/{00000000..00000430}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/66/{00000000..00001278}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/136/{00000000..00001151}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/137/{00000000..00001151}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/138/{00000000..00001143}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/139/{00000000..00001151}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/140/{00000000..00001151}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/141/{00000000..00001151}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/142/{00000000..00001151}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/143/{00000000..00001129}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/144/{00000000..00001095}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/145/{00000000..00001140}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/146/{00000000..00001137}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/147/{00000000..00001134}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/148/{00000000..00001128}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/149/{00000000..00001125}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/150/{00000000..00001134}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/151/{00000000..00001106}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/152/{00000000..00001036}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/153/{00000000..00000994}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/154/{00000000..00001050}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/155/{00000000..00001071}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/156/{00000000..00001077}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/157/{00000000..00001081}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/158/{00000000..00001070}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/159/{00000000..00001066}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/160/{00000000..00001062}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/161/{00000000..00001046}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/162/{00000000..00000976}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/164/{00000000..00000942}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/165/{00000000..00000952}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/166/{00000000..00001151}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/167/{00000000..00001151}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/168/{00000000..00001151}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/169/{00000000..00001151}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/170/{00000000..00001151}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/171/{00000000..00001151}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/172/{00000000..00001151}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/173/{00000000..00001151}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/174/{00000000..00001022}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/175/{00000000..00001005}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/176/{00000000..00000978}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/177/{00000000..00001000}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/178/{00000000..00000993}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/179/{00000000..00001003}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/180/{00000000..00000997}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/181/{00000000..00001056}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/182/{00000000..00001117}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/183/{00000000..00001115}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/184/{00000000..00001104}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/185/{00000000..00001086}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/186/{00000000..00001071}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/187/{00000000..00001078}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/188/{00000000..00001053}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/189/{00000000..00001049}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/190/{00000000..00001023}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/191/{00000000..00001009}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/192/{00000000..00001017}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/193/{00000000..00001023}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/194/{00000000..00000119}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/195/{00000000..00000121}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/196/{00000000..00000120}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/197/{00000000..00000123}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/198/{00000000..00000119}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/199/{00000000..00000124}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/200/{00000000..00000125}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/201/{00000000..00000122}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/202/{00000000..00000123}.tar::s3://s-laion/datanet_7B_pool-baselines/clip_threshold/clip_l14_f0.3/seed_0/reshards_n67/203/{00000000..00000127}.tar -" \
    --train-num-samples 135646078 \
    --dataset-type webdataset \
    --dataset-resampled \
    --warmup 13000 \
    --batch-size=156 \
    --epochs=288 \
    --lr 5e-5 \
    --beta2 0.95 \
    --workers=12 \
    --report-to wandb \
    --name ${EXP_NAME} \
    --logs /fsx/home-mitchellw/experimetns/open_clip/ \
    --model ViT-bigG-14-ls1 \
    --seed 400000 \
    --ddp-static-graph \
    --local-loss \
    --gather-with-grad \
    --grad-checkpointing \
    --precision amp_bfloat16 \
    --save-most-recent \
    --advanced-logging \
    --wandb-project-name open_clip6 \
    --accum-freq 2 \
    --resume "/fsx/home-mitchellw/bigG_14_e256_80.pt"


# --train-data="pipe:aws s3 cp s3://deep-floyd-s3/datasets/{laion_cleaned-part1/{00000..79752}.tar,laion_cleaned-part2/{00000..94330}.tar,laion_cleaned-part3/{00000..94336}.tar,laion_cleaned-part4/{00000..94340}.tar,laion_cleaned-part5/{00000..94333}.tar,laion_cleaned-part6/{00000..77178}.tar} -" \